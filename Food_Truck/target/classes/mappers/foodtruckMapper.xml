<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.foodtruck.dao.FoodTruckDAO">

	<!-- 푸드트럭 상세정보 -->
	<select id="getFoodTruck" resultMap="FoodTruckMap">
		select *
		from
		foodtruck
		where
		FTRUCK_NO = #{ftruckNo}
	</select>

	<!-- 푸드트럭에 달린 갯수 카운트 -->
	<select id="getReviewCount" resultMap="FoodTruckMap">
		select count(r.grade) as count
		from review r,foodtruck f 
		where f.ftruck_no = r.ftruck_no and f.ftruck_no = #{ftruckNo}
	</select>
	
	<!-- 푸드트럭에 달린 리뷰 합계 -->
	<select id="getReviewTotal" resultMap="FoodTruckMap">
		select sum(r.grade) as total
		from review r,foodtruck f 
		where f.ftruck_no = r.ftruck_no and f.ftruck_no = #{ftruckNo}
	</select>

	<!-- 댓글 등록하고 평점 수정 -->
	<update id="updateGrade">
		update foodtruck 
		set
		FTRUCK_GRADE = #{ftruckGrade}
		where FTRUCK_NO = #{ftruckNo}
	</update>

	<!-- 라이센스로 푸드트럭 정보 가져오기 -->
	<select id="getFoodTruck2" resultMap="FoodTruckMap">
		select * from foodtruck where license_no=#{licenseNo}
	</select>

	<!-- 푸드트럭 카테고리별 리스트 -->
	<select id="getCategoryList" resultMap="FoodTruckMap">
		select ffft.* from
		(select fft.*from
		(select rownum as rnum, ft.*
		from (select f.*
		from
		foodtruck f,license l where category=#{category} and f.license_no = l.license_no order by l.app_stat desc,f.FTRUCK_REG) ft)fft
		where rownum &lt;=#{pageNo}+9)ffft
		where rnum >=#{pageNo}
	</select>

	<!-- 푸드트럭 전체 리스트 -->
	<select id="getFoodTruckList" resultMap="FoodTruckMap" parameterType="int">
		select ffft.* from
		(select fft.*from
		(select rownum as
		rnum, ft.*
		from
		(select f.*,l.app_stat from foodtruck f,license l where f.license_no =
		l.license_no order by l.app_stat desc,f.ftruck_reg)
		ft)fft
		where
		rownum<![CDATA[ < ]]>=#{pageNo}+9)ffft
		where rnum>=#{pageNo}
	</select>
	
	<!-- 운영중인 푸드트럭 전체 리스트 -->
	<select id="getRunFoodTruckList" resultMap="FoodTruckMap"
		parameterType="int">
		select ffft.* from
		(select fft.*from
		(select rownum as
		rnum, ft.*
		from
		(select foodtruck.* from
		foodtruck where ftruck_state ='Y'order by FTRUCK_REG)
		ft)fft
		where
		rownum<![CDATA[ < ]]>=#{pageNo}+9)ffft
		where rnum>=#{pageNo}
	</select>
	
	<!-- 마감중인 푸드트럭 전체 리스트 -->
	<select id="getEndFoodTruckList" resultMap="FoodTruckMap"
		parameterType="int">
		select ffft.* from
		(select fft.*from
		(select rownum as
		rnum, ft.*
		from
		(select foodtruck.* from
		foodtruck where ftruck_state ='N'order by FTRUCK_REG)
		ft)fft
		where
		rownum<![CDATA[ < ]]>=#{pageNo}+9)ffft
		where rnum>=#{pageNo}
	</select>


	<!-- 푸드트럭 위클리 랭킹 -->
	<select id="getFoodTruckRank" resultMap="FoodTruckMap" parameterType="int">
		select * from (select f.* from foodtruck f,license l where f.license_no = l.license_no order by l.app_stat desc,ftruck_grade desc)
		where <![CDATA[rownum<=10]]>
	</select>

   <!-- 신규 푸드트럭 -->
   <select id="getNewFoodTruck" resultMap="FoodTruckMap">
      select * from (select f.* from foodtruck f,license l where f.license_no = l.license_no order by l.app_stat desc,ftruck_Reg)
      where <![CDATA[rownum<=10]]>
   </select>	

	<!-- 푸드트럭 위치 Update -->
	<update id="updateTruckPosition">
	update foodtruck set FTRUCK_ADDR=#{ftruckAddr} ,FTRUCK_ADDR2=#{ftruckAddr2} where LICENSE_NO=#{licenseNo}
	
	</update>
	

	<!-- 푸드트럭 삭제 -->
	<delete id="deleteTruck">
		delete from foodtruck
		where FTRUCK_NO = #{ftruckNo}
	</delete>

	<!-- 푸드트럭 수정 -->
	<update id="updateTruck">
		update foodtruck set ftruck_tel = #{ftruckTel},
		FTRUCK_DLV_YN = #{ftruckDlvYn},FTRUCK_RSV_YN =
		#{ftruckRsvYn},ftruck_img = #{ftruckImg},FTRUCK_INTRO=#{ftruckIntro},CATEGORY=#{category}
		where LICENSE_NO = #{licenseNo}
	</update>
	

	<!-- 푸드트럭 카운트(페이징처리) -->
	<select id="getCountTruck" resultType="int">
		select count(*) from
		foodtruck f,license l where f.license_no = l.license_no and l.app_stat = 'Y'
	</select>
	
	<!-- 운영중인 푸드트럭 카운트(페이징처리) -->
	<select id="getRunCountTruck" resultType="int">
		select count(*) from
		foodtruck  where ftruck_state ='Y'
	</select>
	
	<!-- 마감중인 푸드트럭 카운트(페이징처리) -->
	<select id="getEndCountTruck" resultType="int">
		select count(*) from
		foodtruck  where ftruck_state ='N'
	</select>

	<!-- 푸드트럭 카테고리별 카운트(페이징처리) -->
	<select id="getCategoryCountTruck" resultType="int">
		select count(*)
		from foodtruck f,license l where f.license_no = l.license_no and l.app_stat = 'Y' and category=#{category}
	</select>

	<resultMap type="FoodTruckVO" id="FoodTruckMap" extends="ReviewMap">
		<result column="FTRUCK_NO" property="ftruckNo" />
		<result column="LICENSE_NO" property="licenseNo" />
		<result column="FTRUCK_NAME" property="ftruckName" />
		<result column="FTRUCK_TEL" property="ftruckTel" />
		<result column="FTRUCK_ADDR" property="ftruckAddr" />
		<result column="FTRUCK_ADDR2" property="ftruckAddr2" />
		<result column="FTRUCK_DLV_YN" property="ftruckDlvYn" />
		<result column="FTRUCK_RSV_YN" property="ftruckRsvYn" />
		<result column="FTRUCK_GRADE" property="ftruckGrade" />
		<result column="FTRUCK_STATE" property="ftruckState" />
		<result column="FTRUCK_IMG" property="ftruckImg" />
		<result column="FTRUCK_INTRO" property="ftruckIntro" />
		<result column="FTRUCK_REG" property="ftruckReg" />

		<result column="CATEGORY" property="category" />

		<result column="COUNT" property="count" />
		<result column="TOTAL" property="total" />		

	</resultMap>
	
	<resultMap type="com.foodtruck.vo.LicenseVO" id="LicenseMap">
		<result column="LICENSE_NO" property="licenseNo" />
		<result column="MEM_ID" property="memId" />
		<result column="APP_STAT" property="appStat" />
	</resultMap>
	
	<resultMap type="com.foodtruck.vo.ReviewVO" id="ReviewMap">
		<result column="GRADE" property="grade" />
		<result column="FTRUCK_NO" property="ftruckNo" />
	</resultMap>

</mapper>